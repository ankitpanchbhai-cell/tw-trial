<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Barcode Scanner → Google Sheet</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0c10; color: #eaf0ff; }
    header { padding: 14px 14px 10px; position: sticky; top: 0; background: rgba(11,12,16,.92); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,.08); }
    h1 { margin: 0 0 8px; font-size: 16px; font-weight: 700; letter-spacing: .2px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    input, select, button {
      height: 42px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06); color: #eaf0ff; padding: 0 12px; font-size: 14px;
      outline: none;
    }
    input::placeholder { color: rgba(234,240,255,.55); }
    button { cursor: pointer; background: rgba(255,255,255,.12); }
    button.primary { background: #2b6cff; border-color: rgba(43,108,255,.5); }
    button.danger { background: rgba(255,60,60,.18); border-color: rgba(255,60,60,.25); }
    button:disabled { opacity: .55; cursor: not-allowed; }
    main { padding: 14px; }
    .card { border: 1px solid rgba(255,255,255,.10); border-radius: 14px; overflow: hidden; background: rgba(255,255,255,.04); }
    .videoWrap { position: relative; background: #000; }
    video { width: 100%; height: auto; display:block; }
    .overlay {
      position:absolute; inset:0; pointer-events:none;
      display:flex; align-items:center; justify-content:center;
    }
    .box {
      width: 78%; max-width: 520px; aspect-ratio: 3/1;
      border: 2px solid rgba(43,108,255,.85);
      border-radius: 14px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
    }
    .stats { display:flex; gap:10px; flex-wrap: wrap; padding: 12px; border-top: 1px solid rgba(255,255,255,.08); }
    .pill { padding: 8px 10px; border-radius: 999px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); font-size: 13px; }
    .log { margin-top: 12px; }
    .log h2 { font-size: 14px; margin: 0 0 8px; opacity: .9; }
    .list { display:flex; flex-direction: column; gap: 8px; }
    .item {
      padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:flex; justify-content: space-between; gap: 10px; align-items: center;
    }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; word-break: break-all; }
    .muted { opacity: .65; font-size: 12px; }
    .status { margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }
    .ok { border-color: rgba(43,255,130,.25); }
    .err { border-color: rgba(255,70,70,.30); }
    .tiny { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
<header>
  <h1>Scanner → Google Sheet</h1>
  <div class="row">
    <select id="mode">
      <option value="SCAN">SCAN</option>
      <option value="IN">IN</option>
      <option value="OUT">OUT</option>
      <option value="RETURN">RETURN</option>
      <option value="QC">QC</option>
    </select>
    <input id="notes" placeholder="Notes (optional)" />
    <button id="btnStart" class="primary">Start</button>
    <button id="btnStop" disabled>Stop</button>
    <button id="btnTorch" disabled>Torch</button>
    <button id="btnClear" class="danger">Clear</button>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="deviceId" placeholder="Device ID (auto)" />

    <label class="pill" style="display:flex;align-items:center;gap:8px">
      <input id="allowDuplicates" type="checkbox" />
      Allow duplicates
    </label>

    <input id="scanDelay" type="number" min="200" step="100" style="width:170px"
           placeholder="Scan delay (ms)" />
  </div>
</header>

<main>
  <div class="card">
    <div class="videoWrap">
      <video id="video" playsinline muted></video>
      <div class="overlay"><div class="box"></div></div>
    </div>
    <div class="stats">
      <div class="pill">Uploaded: <b id="count">0</b></div>
      <div class="pill">Pending: <b id="pending">0</b></div>
      <div class="pill">Last: <span id="last" class="muted">—</span></div>
    </div>
  </div>

  <div id="status" class="status tiny">Status: idle</div>

  <div class="log">
    <h2>Recent scans</h2>
    <div id="list" class="list"></div>
  </div>
</main>

<script>
  // ========= CONFIG =========
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbzF6vTl-fI6HT4vIvJ1NfFtmm6yUX6Tf_Ql3ckpcFv51p5Pxmgbp9n6pksvgHpOrLQu3w/exec";

  // (assumption/estimation) Default scan lock time in ms (prevents repeated hits of same physical label)
  const DEFAULT_SCAN_DELAY_MS = 1500;

  // (assumption/estimation) Frame detection interval for BarcodeDetector
  const DETECT_INTERVAL_MS = 180;
  // ==========================

  const elVideo = document.getElementById("video");
  const elStart = document.getElementById("btnStart");
  const elStop  = document.getElementById("btnStop");
  const elTorch = document.getElementById("btnTorch");
  const elClear = document.getElementById("btnClear");
  const elMode  = document.getElementById("mode");
  const elNotes = document.getElementById("notes");
  const elDeviceId = document.getElementById("deviceId");
  const elAllowDup = document.getElementById("allowDuplicates");
  const elScanDelay = document.getElementById("scanDelay");

  const elCount = document.getElementById("count");
  const elPending = document.getElementById("pending");
  const elLast = document.getElementById("last");
  const elList = document.getElementById("list");
  const elStatus = document.getElementById("status");

  let stream = null;
  let track = null;
  let scanning = false;

  // Anti-repeat: lock all scanning for X ms after a successful scan
  let lockedUntil = 0;

  // Keep last code for display only
  let lastAcceptedCode = "";

  // Simple in-memory queue
  const queue = [];
  let uploadedCount = 0;

  // Audio (beep) — must be unlocked by user gesture
  let audioCtx = null;

  function setStatus(msg, kind="") {
    elStatus.classList.remove("ok","err");
    if (kind) elStatus.classList.add(kind);
    elStatus.textContent = "Status: " + msg;
  }

  function getScanDelayMs() {
    const v = Number(elScanDelay.value);
    if (Number.isFinite(v) && v >= 200) return v;
    return DEFAULT_SCAN_DELAY_MS;
  }

  function beep() {
    try {
      if (!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.06;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(() => { try { o.stop(); } catch(_) {} }, 80);
    } catch (_) {}
  }

  function vibrate() {
    try { navigator.vibrate?.(60); } catch (_) {}
  }

  function getOrCreateDeviceId() {
    const key = "scanner_device_id_v1";
    let id = localStorage.getItem(key);
    if (!id) {
      id = "dev_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem(key, id);
    }
    return id;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function addToUI(code) {
    elLast.textContent = code;
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="code">${escapeHtml(code)}</div>
      <div class="muted">${new Date().toLocaleTimeString()}</div>
    `;
    elList.prepend(item);
    while (elList.children.length > 25) elList.removeChild(elList.lastChild);
  }

  function setCounts() {
    elCount.textContent = String(uploadedCount);
    elPending.textContent = String(queue.length);
  }

  // Core acceptance rule:
  // - If Allow duplicates OFF: still allow scanning same SKU again, but only after scanDelay time
  // - If Allow duplicates ON: same rule (otherwise it becomes machine-gun). The checkbox mostly affects other logic you may add later.
  function canAcceptNow() {
    return Date.now() >= lockedUntil;
  }

  async function onGoodScan(code) {
    if (!canAcceptNow()) return;

    // Lock scanning for X ms
    lockedUntil = Date.now() + getScanDelayMs();

    lastAcceptedCode = code;
    beep();
    vibrate();

    await enqueueAndSend(code);
  }

  async function enqueueAndSend(code) {
    addToUI(code);

    const payload = {
      barcode: code,
      device_id: elDeviceId.value.trim(),
      mode: elMode.value,
      notes: elNotes.value.trim()
    };

    queue.push(payload);
    setCounts();
    flushQueue().catch(()=>{});
  }

  async function flushQueue() {
    if (queue.length === 0) return;

    // Send one-by-one (stable with Apps Script)
    while (queue.length > 0) {
      const payload = queue[0];

      try {
        // IMPORTANT: form-urlencoded to avoid CORS preflight issues with Apps Script
        const body = new URLSearchParams(payload).toString();

        const res = await fetch(ENDPOINT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });

        const text = await res.text().catch(() => "");
        if (!res.ok) throw new Error("HTTP " + res.status + " " + text);

        queue.shift();
        uploadedCount++;
        setCounts();
        setStatus("uploaded ✓", "ok");
      } catch (err) {
        setStatus("upload failed (will retry): " + String(err), "err");
        break;
      }
    }
  }

  async function startCamera() {
    const constraints = {
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    };

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    elVideo.srcObject = stream;
    await elVideo.play();

    track = stream.getVideoTracks()[0];

    // enable torch button if supported
    const caps = track.getCapabilities?.() || {};
    elTorch.disabled = !caps.torch;

    setStatus("camera started");
  }

  async function stopCamera() {
    try { elVideo.pause(); } catch(_) {}
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    track = null;
    elTorch.disabled = true;
    setStatus("camera stopped");
  }

  let torchOn = false;
  async function toggleTorch() {
    if (!track) return;
    const caps = track.getCapabilities?.() || {};
    if (!caps.torch) return;
    torchOn = !torchOn;
    try {
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
    } catch (e) {
      torchOn = false;
    }
  }

  // ---------- Scanner engines ----------
  let detector = null;
  let detectTimer = null;
  let zxingReader = null;

  async function startScanning() {
    scanning = true;
    elStart.disabled = true;
    elStop.disabled = false;

    // Prefer BarcodeDetector if available
    if ("BarcodeDetector" in window) {
      try {
        const formats = await window.BarcodeDetector.getSupportedFormats?.();
        detector = new window.BarcodeDetector({ formats: formats || undefined });
        setStatus("scanner engine: BarcodeDetector");
        startBarcodeDetectorLoop();
        return;
      } catch (e) {
        // fallback to ZXing
      }
    }

    setStatus("scanner engine: ZXing (fallback)");
    await loadZXing();
    startZXingLoop();
  }

  function stopScanning() {
    scanning = false;
    elStart.disabled = false;
    elStop.disabled = true;

    if (detectTimer) {
      clearInterval(detectTimer);
      detectTimer = null;
    }
    if (zxingReader) {
      try { zxingReader.reset(); } catch(_) {}
    }
    setStatus("idle");
  }

  function startBarcodeDetectorLoop() {
    if (!detector) return;

    detectTimer = setInterval(async () => {
      if (!scanning) return;
      if (elVideo.readyState < 2) return;

      try {
        const barcodes = await detector.detect(elVideo);
        if (!barcodes || barcodes.length === 0) return;

        const raw = (barcodes[0].rawValue || "").trim();
        if (!raw) return;

        await onGoodScan(raw);
      } catch (_) {}
    }, DETECT_INTERVAL_MS);
  }

  async function loadZXing() {
    if (window.ZXing?.BrowserMultiFormatReader) return;

    await new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = "https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js";
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  function startZXingLoop() {
    zxingReader = new ZXing.BrowserMultiFormatReader();

    // Correct continuous API (important for iPhone fallback)
    zxingReader.decodeFromVideoElementContinuously(elVideo, async (result, err) => {
      if (!scanning) return;
      if (result && result.text) {
        const raw = result.text.trim();
        if (!raw) return;
        await onGoodScan(raw);
      }
    });
  }

  // ---------- UI wiring ----------
  elDeviceId.value = getOrCreateDeviceId();
  elScanDelay.value = String(DEFAULT_SCAN_DELAY_MS);

  elStart.addEventListener("click", async () => {
    try {
      setStatus("starting…");

      // Unlock audio on user gesture (needed on many phones)
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      try { await audioCtx.resume(); } catch (_) {}

      await startCamera();
      await startScanning();

      // One beep to confirm audio is unlocked
      beep();
    } catch (e) {
      setStatus("start failed: " + String(e), "err");
      elStart.disabled = false;
      elStop.disabled = true;
    }
  });

  elStop.addEventListener("click", async () => {
    stopScanning();
    await stopCamera();
  });

  elTorch.addEventListener("click", async () => {
    await toggleTorch();
  });

  elClear.addEventListener("click", () => {
    elList.innerHTML = "";
    lastAcceptedCode = "";
    lockedUntil = 0;
    setStatus("cleared recent list");
  });

  window.addEventListener("online", () => flushQueue().catch(()=>{}));
</script>
</body>
</html>
